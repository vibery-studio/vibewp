"""Malware detection and cleanup commands for WordPress sites"""

import typer
from typing import Optional
from rich.table import Table
from rich.panel import Panel
from cli.ui.console import console, print_success, print_error, print_warning, print_info, confirm
from cli.utils.ssh import SSHManager
from cli.utils.config import ConfigManager

app = typer.Typer(help="Malware detection and cleanup")


def detect_suspicious_plugins(ssh: SSHManager, site_name: str) -> dict:
    """
    Detect suspicious plugins using safe heuristics

    Returns dict with categorized suspicious plugins
    """
    wpcli_container = f"{site_name}_wpcli"

    # Get all plugins with details
    exit_code, output, stderr = ssh.run_command(
        f"docker exec {wpcli_container} wp plugin list --format=json",
        timeout=30
    )

    if exit_code != 0:
        return {"error": stderr}

    import json
    try:
        plugins = json.loads(output)
    except:
        return {"error": "Failed to parse plugin list"}

    suspicious = {
        "random_names": [],      # Plugins with random/gibberish names
        "no_description": [],    # Plugins with no description
        "inactive_suspicious": [],  # Inactive plugins that look suspicious
        "recent_additions": []   # Recently added plugins (last 7 days)
    }

    for plugin in plugins:
        name = plugin.get("name", "")
        title = plugin.get("title", "")
        status = plugin.get("status", "")
        description = plugin.get("description", "")

        # Check for random gibberish names (7 chars, all lowercase, no vowels pattern)
        if len(name) == 7 and name.islower() and name.isalpha():
            vowel_count = sum(1 for c in name if c in 'aeiou')
            if vowel_count <= 2:  # Very few vowels suggests random string
                suspicious["random_names"].append({
                    "name": name,
                    "title": title,
                    "status": status,
                    "reason": "Random 7-char name pattern"
                })

        # Check for plugins with no description
        if not description or description == "":
            suspicious["no_description"].append({
                "name": name,
                "title": title,
                "status": status,
                "reason": "No description"
            })

        # Flag inactive suspicious plugins
        if status == "inactive" and (len(name) == 7 and name.islower()):
            suspicious["inactive_suspicious"].append({
                "name": name,
                "title": title,
                "status": status,
                "reason": "Inactive with suspicious name"
            })

    return suspicious


def detect_suspicious_files(ssh: SSHManager, site_name: str) -> dict:
    """
    Detect suspicious PHP files in WordPress root (non-destructive scan)

    Returns dict with suspicious files
    """
    wp_container = f"{site_name}_wp"

    suspicious_files = {
        "root_php_files": [],    # PHP files in root that shouldn't be there
        "hidden_files": [],      # Hidden PHP files
        "suspicious_names": []   # Files with suspicious names
    }

    # List PHP files in WordPress root (excluding core files)
    core_files = [
        "index.php", "wp-activate.php", "wp-blog-header.php", "wp-comments-post.php",
        "wp-config-sample.php", "wp-config.php", "wp-cron.php", "wp-links-opml.php",
        "wp-load.php", "wp-login.php", "wp-mail.php", "wp-settings.php",
        "wp-signup.php", "wp-trackback.php", "xmlrpc.php"
    ]

    exit_code, output, stderr = ssh.run_command(
        f"docker exec {wp_container} find /var/www/html -maxdepth 1 -name '*.php' -type f",
        timeout=30
    )

    if exit_code == 0:
        files = output.strip().split('\n')
        for filepath in files:
            if not filepath:
                continue

            filename = filepath.split('/')[-1]

            # Skip core WordPress files
            if filename in core_files:
                continue

            # Check for hidden files
            if filename.startswith('.'):
                suspicious_files["hidden_files"].append({
                    "path": filepath,
                    "name": filename,
                    "reason": "Hidden PHP file"
                })
            # Check for suspicious names
            elif len(filename) < 15 and not any(word in filename.lower() for word in ['config', 'setup', 'install']):
                suspicious_files["root_php_files"].append({
                    "path": filepath,
                    "name": filename,
                    "reason": "Non-core PHP file in root"
                })

    return suspicious_files


@app.command("scan")
def scan_malware(
    site_name: str = typer.Argument(..., help="Site name to scan"),
    detailed: bool = typer.Option(False, "--detailed", help="Show detailed analysis")
):
    """
    Scan WordPress site for malware indicators (non-destructive)

    This command only scans and reports. It does NOT modify anything.
    """
    try:
        config_mgr = ConfigManager()
        config_mgr.load_config()

        site = config_mgr.get_site(site_name)
        if not site:
            print_error(f"Site '{site_name}' not found")
            raise typer.Exit(code=1)

        # Connect to VPS
        ssh = SSHManager(
            host=config_mgr.vps.host,
            port=config_mgr.vps.port,
            user=config_mgr.vps.user,
            key_path=config_mgr.vps.key_path
        )

        ssh.connect()

        try:
            console.print(f"\n[bold cyan]üîç Scanning {site_name} for malware indicators...[/bold cyan]\n")

            # Scan plugins
            print_info("Analyzing plugins...")
            suspicious_plugins = detect_suspicious_plugins(ssh, site_name)

            # Scan files
            print_info("Analyzing files...")
            suspicious_files = detect_suspicious_files(ssh, site_name)

            # Display results
            console.print("\n[bold]‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê[/bold]")
            console.print("[bold cyan]Malware Scan Results[/bold cyan]")
            console.print("[bold]‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê[/bold]\n")

            total_issues = 0

            # Suspicious plugins report
            if suspicious_plugins.get("random_names"):
                count = len(suspicious_plugins["random_names"])
                total_issues += count
                console.print(f"[yellow]‚ö† Found {count} plugin(s) with random names:[/yellow]")

                table = Table(show_header=True)
                table.add_column("Plugin Name", style="red")
                table.add_column("Title", style="yellow")
                table.add_column("Status")
                table.add_column("Reason", style="dim")

                for plugin in suspicious_plugins["random_names"]:
                    table.add_row(
                        plugin["name"],
                        plugin["title"],
                        plugin["status"],
                        plugin["reason"]
                    )

                console.print(table)
                console.print()

            # Suspicious files report
            if suspicious_files.get("root_php_files"):
                count = len(suspicious_files["root_php_files"])
                total_issues += count
                console.print(f"[yellow]‚ö† Found {count} suspicious PHP file(s) in root:[/yellow]")

                table = Table(show_header=True)
                table.add_column("File Name", style="red")
                table.add_column("Path", style="dim")
                table.add_column("Reason", style="yellow")

                for file in suspicious_files["root_php_files"]:
                    table.add_row(
                        file["name"],
                        file["path"],
                        file["reason"]
                    )

                console.print(table)
                console.print()

            if suspicious_files.get("hidden_files"):
                count = len(suspicious_files["hidden_files"])
                total_issues += count
                console.print(f"[red]‚ö† Found {count} hidden PHP file(s):[/red]")

                for file in suspicious_files["hidden_files"]:
                    console.print(f"  ‚Ä¢ [red]{file['path']}[/red]")
                console.print()

            # Summary
            if total_issues > 0:
                console.print(Panel(
                    f"[yellow]Found {total_issues} potential malware indicator(s)[/yellow]\n\n"
                    f"[dim]Next steps:[/dim]\n"
                    f"1. Review the findings above\n"
                    f"2. Backup your site: [cyan]vibewp backup create {site_name}[/cyan]\n"
                    f"3. Remove suspicious items: [cyan]vibewp malware cleanup {site_name}[/cyan]\n"
                    f"4. Reinstall WordPress core: [cyan]vibewp site reinstall-core {site_name}[/cyan]",
                    title="‚ö†Ô∏è  Action Required",
                    border_style="yellow"
                ))
            else:
                console.print(Panel(
                    "[green]‚úì No obvious malware indicators detected[/green]\n\n"
                    "[dim]This scan checks for common patterns. For comprehensive security:[/dim]\n"
                    "‚Ä¢ Run: [cyan]vibewp security audit-server[/cyan]\n"
                    "‚Ä¢ Consider professional malware scanning service",
                    title="‚úì Scan Complete",
                    border_style="green"
                ))

        finally:
            ssh.disconnect()

    except Exception as e:
        print_error(f"Error: {e}")
        raise typer.Exit(code=1)


@app.command("cleanup")
def cleanup_malware(
    site_name: str = typer.Argument(..., help="Site name to clean"),
    plugins: Optional[str] = typer.Option(None, "--plugins", help="Comma-separated list of plugin names to remove"),
    files: Optional[str] = typer.Option(None, "--files", help="Comma-separated list of file paths to remove"),
    auto: bool = typer.Option(False, "--auto", help="Automatically remove all detected suspicious items"),
    backup_first: bool = typer.Option(True, "--backup/--no-backup", help="Create backup before cleanup")
):
    """
    Clean up malware from WordPress site (REQUIRES CONFIRMATION)

    This command removes specified plugins and files. Always creates backup first.
    """
    try:
        config_mgr = ConfigManager()
        config_mgr.load_config()

        site = config_mgr.get_site(site_name)
        if not site:
            print_error(f"Site '{site_name}' not found")
            raise typer.Exit(code=1)

        # Safety check
        if not plugins and not files and not auto:
            print_error("You must specify items to clean:")
            print_info("  --plugins 'plugin1,plugin2'  Remove specific plugins")
            print_info("  --files 'file1.php,file2.php'  Remove specific files")
            print_info("  --auto  Auto-remove all detected suspicious items")
            raise typer.Exit(code=1)

        # Connect to VPS
        ssh = SSHManager(
            host=config_mgr.vps.host,
            port=config_mgr.vps.port,
            user=config_mgr.vps.user,
            key_path=config_mgr.vps.key_path
        )

        ssh.connect()

        try:
            # Create backup first
            if backup_first:
                print_info(f"Creating backup of {site_name} before cleanup...")
                from cli.commands.backup import create_backup
                create_backup(site_name, compress=True, remote=False)

            wpcli_container = f"{site_name}_wpcli"
            wp_container = f"{site_name}_wp"

            items_to_remove = {
                "plugins": [],
                "files": []
            }

            # Auto mode: scan and collect suspicious items
            if auto:
                print_info("Scanning for suspicious items...")
                suspicious_plugins = detect_suspicious_plugins(ssh, site_name)
                suspicious_files = detect_suspicious_files(ssh, site_name)

                # Collect random-named plugins
                for plugin in suspicious_plugins.get("random_names", []):
                    items_to_remove["plugins"].append(plugin["name"])

                # Collect suspicious files
                for file in suspicious_files.get("root_php_files", []):
                    items_to_remove["files"].append(file["path"])

                for file in suspicious_files.get("hidden_files", []):
                    items_to_remove["files"].append(file["path"])

            # Manual mode: use specified items
            if plugins:
                items_to_remove["plugins"].extend(plugins.split(','))

            if files:
                items_to_remove["files"].extend(files.split(','))

            # Show what will be removed
            console.print("\n[bold yellow]‚ö†Ô∏è  Items to be removed:[/bold yellow]\n")

            if items_to_remove["plugins"]:
                console.print("[bold]Plugins:[/bold]")
                for plugin in items_to_remove["plugins"]:
                    console.print(f"  ‚Ä¢ [red]{plugin}[/red]")
                console.print()

            if items_to_remove["files"]:
                console.print("[bold]Files:[/bold]")
                for file in items_to_remove["files"]:
                    console.print(f"  ‚Ä¢ [red]{file}[/red]")
                console.print()

            # Final confirmation
            if not confirm(f"\n‚ö†Ô∏è  Remove {len(items_to_remove['plugins'])} plugin(s) and {len(items_to_remove['files'])} file(s)?", default=False):
                print_info("Cleanup cancelled")
                return

            # Remove plugins
            if items_to_remove["plugins"]:
                print_info(f"Removing {len(items_to_remove['plugins'])} plugin(s)...")
                for plugin in items_to_remove["plugins"]:
                    exit_code, stdout, stderr = ssh.run_command(
                        f"docker exec {wpcli_container} wp plugin delete {plugin} --allow-root",
                        timeout=30
                    )
                    if exit_code == 0:
                        print_success(f"  ‚úì Removed plugin: {plugin}")
                    else:
                        print_warning(f"  ‚úó Failed to remove plugin: {plugin}")

            # Remove files
            if items_to_remove["files"]:
                print_info(f"Removing {len(items_to_remove['files'])} file(s)...")
                for filepath in items_to_remove["files"]:
                    exit_code, stdout, stderr = ssh.run_command(
                        f"docker exec --user root {wp_container} rm -f {filepath}",
                        timeout=10
                    )
                    if exit_code == 0:
                        print_success(f"  ‚úì Removed file: {filepath}")
                    else:
                        print_warning(f"  ‚úó Failed to remove file: {filepath}")

            console.print("\n[bold green]‚úì Cleanup completed[/bold green]\n")
            console.print(Panel(
                "[bold]Recommended next steps:[/bold]\n\n"
                f"1. Reinstall WordPress core: [cyan]vibewp site reinstall-core {site_name}[/cyan]\n"
                f"2. Scan again to verify: [cyan]vibewp malware scan {site_name}[/cyan]\n"
                f"3. Update all plugins: [cyan]vibewp ssh exec {site_name}_wpcli wp plugin update --all[/cyan]\n"
                "4. Change WordPress admin password\n"
                "5. Review user accounts for suspicious users",
                title="üîí Security Hardening",
                border_style="green"
            ))

        finally:
            ssh.disconnect()

    except Exception as e:
        print_error(f"Error: {e}")
        raise typer.Exit(code=1)


if __name__ == "__main__":
    app()
