{# OpenLiteSpeed Stack Template
   Uses: litespeedtech/openlitespeed:latest
   Pros: High performance, LSCache support, enterprise-grade
   Cons: Requires custom vhost configuration

   Auto-configuration:
   - Custom entrypoint script configures vhost on startup
   - Maps domain to /var/www/vhosts/{{ domain }}
   - Configures listeners and PHP processing
   - Supports .htaccess rewrite rules
#}
version: '3.8'

services:
  litespeed:
    image: litespeedtech/openlitespeed:latest
    container_name: {{ site_name }}_ols
    environment:
      - DOMAIN={{ domain }}
      - LSWS_USER={{ lsws_admin_user | default('admin') }}
      - LSWS_PASS={{ lsws_admin_pass | replace('$', '$$') }}
      - LS_OLS_ENABLE_LSCACHE=true
      # Redis configuration for object caching
{% if db_mode == 'shared' %}
      - WORDPRESS_DB_HOST=vibewp_shared_db
{% else %}
      - WORDPRESS_DB_HOST=mysql
{% endif %}
      - WORDPRESS_DB_USER={{ db_user }}
      - WORDPRESS_DB_PASSWORD={{ db_password | replace('$', '$$') }}
      - WORDPRESS_DB_NAME={{ db_name }}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    volumes:
      - ./sites/{{ site_name }}:/var/www/vhosts/{{ domain }}
      - lsws_conf:/usr/local/lsws/conf
      - lsws_admin_conf:/usr/local/lsws/admin/conf
      - acme:/root/.acme.sh
      - lsws_logs:/usr/local/lsws/logs
      # Custom configuration files
      - ./config/ols/vhconf.conf.template:/tmp/vhconf.conf.template:ro
      - ./config/ols/configure-ols.sh:/usr/local/bin/configure-ols.sh:ro
    entrypoint: ["/bin/bash", "/usr/local/bin/configure-ols.sh"]
    command: []
    networks:
{% if db_mode == 'shared' %}
      - proxy
{% else %}
      - default
      - proxy
{% endif %}
    labels:
      # Caddy proxy configuration
      caddy: {{ domain }}
      caddy.reverse_proxy: "{{ '{{upstreams 8088}}' }}"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    ports:
      # Admin panel (only expose on localhost or VPN)
      - "127.0.0.1:{{ admin_port | default(7080) }}:7080"

  wpcli:
    image: wordpress:cli
    container_name: {{ site_name }}_wpcli
    user: "33:33"
    environment:
{% if db_mode == 'shared' %}
      WORDPRESS_DB_HOST: vibewp_shared_db:3306
{% else %}
      WORDPRESS_DB_HOST: mysql:3306
{% endif %}
      WORDPRESS_DB_USER: {{ db_user }}
      WORDPRESS_DB_PASSWORD: "{{ db_password | replace('$', '$$') }}"
      WORDPRESS_DB_NAME: {{ db_name }}
      WP_CLI_CACHE_DIR: /var/www/vhosts/{{ domain }}/.wp-cli/cache
      PHP_MEMORY_LIMIT: 512M
      MYSQL_SSL: "false"
    volumes:
      - ./sites/{{ site_name }}:/var/www/vhosts/{{ domain }}
    working_dir: /var/www/vhosts/{{ domain }}
    networks:
{% if db_mode == 'shared' %}
      - proxy
{% else %}
      - default
{% endif %}
{% if db_mode == 'dedicated' %}
    depends_on:
      mysql:
        condition: service_healthy
{% endif %}
    entrypoint: sh
    command: -c "sleep infinity"

{% if db_mode == 'dedicated' %}
  mysql:
    image: mariadb:10.11
    container_name: {{ site_name }}_db
    environment:
      MYSQL_DATABASE: {{ db_name }}
      MYSQL_USER: {{ db_user }}
      MYSQL_PASSWORD: "{{ db_password | replace('$', '$$') }}"
      MYSQL_RANDOM_ROOT_PASSWORD: '1'
      MYSQL_INITDB_SKIP_TZINFO: '1'
    volumes:
      - db_data:/var/lib/mysql
    networks:
      - default
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    command: >
      --default-authentication-plugin=mysql_native_password
      --max_connections=100
      --innodb_buffer_pool_size=512M
      --innodb_log_file_size=128M
      --query_cache_size=32M
      --query_cache_type=1
      --innodb-use-native-aio=0
      --skip-ssl
{% endif %}

  redis:
    image: redis:alpine
    container_name: {{ site_name }}_redis
    command: >
      redis-server
      --maxmemory {{ redis_maxmemory | default('256mb') }}
      --maxmemory-policy allkeys-lru
      --save 60 1000
      --appendonly yes
    volumes:
      - redis_data:/data
    networks:
{% if db_mode == 'shared' %}
      - proxy
{% else %}
      - default
{% endif %}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  phpmyadmin:
    image: phpmyadmin:latest
    container_name: {{ site_name }}_pma
    environment:
{% if db_mode == 'shared' %}
      PMA_HOST: vibewp_shared_db
{% else %}
      PMA_HOST: mysql
{% endif %}
      PMA_PORT: 3306
      PMA_USER: {{ db_user }}
      PMA_PASSWORD: "{{ db_password | replace('$', '$$') }}"
      UPLOAD_LIMIT: 128M
    networks:
{% if db_mode == 'shared' %}
      - proxy
{% else %}
      - default
{% endif %}
    restart: unless-stopped
    labels:
      # phpMyAdmin via Caddy (secure subdomain)
      caddy: pma.{{ domain }}
      caddy.reverse_proxy: "{{ '{{upstreams 80}}' }}"
      caddy.tls: "internal"
      # Basic auth for additional security (optional)
      {% if pma_basic_auth %}
      caddy.basicauth: "/*"
      caddy.basicauth.{{ pma_auth_user }}: "{{ pma_auth_pass_hash }}"
      {% endif %}

volumes:
{% if db_mode == 'dedicated' %}
  db_data:
    name: {{ site_name }}_db_data
{% endif %}
  redis_data:
    name: {{ site_name }}_redis_data
  lsws_conf:
    name: {{ site_name }}_lsws_conf
  lsws_admin_conf:
    name: {{ site_name }}_lsws_admin_conf
  acme:
    name: {{ site_name }}_acme
  lsws_logs:
    name: {{ site_name }}_lsws_logs

networks:
{% if db_mode == 'dedicated' %}
  default:
    name: {{ site_name }}_default
{% endif %}
  proxy:
    external: true
